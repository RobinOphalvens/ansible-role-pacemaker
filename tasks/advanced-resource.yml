---
- include_tasks: pre.yml

- name: Create {{ pcmk_resource.type }} resource {{ pcmk_resource.name }}
  xml:
    path: "{{ pcmk_config.path }}"
    xpath: "/cib/configuration/resources/{{ pcmk_resource.type }}[@id='{{ pcmk_resource.name }}']"
  check_mode: false
  run_once: true

- name: Configure attributes for {{ pcmk_resource.name }}
  include_tasks: _nvpair.yml
  vars:
    nvpair_parent: >-
      {{ '/cib/configuration/resources/' ~
      '%(type)s[@id="%(id)s"]/meta_attributes[@id="%(id)s-meta_attributes"]'
      | format(type = pcmk_resource.type, id = pcmk_resource.name) }}
    parent_id: "{{ pcmk_resource.name }}"
  with_dict: "{{ pcmk_resource.meta | default({}) }}"
  loop_control:
    loop_var: nvpair
    label: "{{ '{' ~ nvpair.name ~ ': ' ~ nvpair.value ~ '}' }}"
  run_once: true

- name: Create resources in {{ pcmk_resource.name }}
  include_tasks: _primitive.yml
  vars:
    primitive_parent: >-
      {{ '/cib/configuration/resources/%(type)s[@id="%(id)s"]'
      | format(type = pcmk_resource.type, id = pcmk_resource.name) }}
    parent_id: "{{ pcmk_resource.name }}"
  with_dict: "{{ pcmk_resource.resources | default({}) }}"
  loop_control:
    loop_var: primitive
  run_once: true

- include_tasks: post.yml
